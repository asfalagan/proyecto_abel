<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esqueleto</title>
    <link rel="stylesheet" href="./css/css.css">
    <link rel="stylesheet" href="./css/landing.css">
    <script src="https://kit.fontawesome.com/a5191f3c7b.js" crossorigin="anonymous"></script>
    <script src="./js/jwt.js"></script>
</head>
<body>
    <header id="headerbar">
        <a href="./main.html" class="enlace-header">
            <i class="fa-solid fa-person-running">
                <span class="header-span">RaceBook</span>
            </i>
        </a>
        <!-- Si la pantalla es suficientemente grande se mostrará el #headerbarlinks ; en movil se mostrara un menú desplegable-->
        <div id="headerbarlinks">
            <a class="enlace-header" href="./main.html">Catálogo de Carreras</a>
            <!--Cuando el usuario se ha logeado el contenido de este elemento cambia; será un acceso a la cuenta del usuario-->
            <a class="enlace-header" id="enlace-cuenta" href="./login.html" id="loginbuttonheader">
                <i class="fa-regular fa-user">
                    <span  class="header-span">Login</span>
                </i>
            </a>
        </div>
        <div id="menu-desplegable">
            <div id="burguer-menu">
                <i class="fa-solid fa-bars" id="menu-hamburguesa"></i>
                <ul id="enlaces-menu-desplegable" class="hidden">
                    <li><a class="enlace-menu-hambuerguesa" href="./main.html">Catálogo de Carreras</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./registro.html">Registro</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./login.html">Login</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./politica.html">Términos Legales</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./contancto.html">Atención al Cliente</a></li>
                </ul>
            </div>
        </div>
    </header>
    <!--Estos dos divs corresponden a la capa de fondo de pantalla mas la capa de transparencia ocupan todo el alto que no ocupa el header-->
    <div id="background"></div>
    <div id="opaca"></div>
    <nav>
        <div id="searchbar"></div>
        <div id="breadcrumbs"></div>
    </nav>
    <main id="mainContainer">
        <form action="">
            <!--Formulario para recoger los datos que faltan para finalizar el registro de usuario-->
            <div id="login-alert">Rellena los datos para completar el registro</div>
            <label for="nombre">Nombre</label>
            <input type="text" name="nombre" id="nombre" placeholder="Nombre">
            <label for="apellidos">Nickname</label>
            <input type="text" name="nickname" id="nickname" placeholder="Apellidos">
            <label for="fechaNacimiento">Fecha de Nacimiento</label>
            <input type="date" name="fechaNacimiento" id="fechaNacimiento" placeholder="Fecha de Nacimiento">
            <label for="telefono">Teléfono</label>
            <input type="tel" id="telefono" name="telefono" placeholder="Teléfono">
            <label for="entidad">Nombre de la Entidad</label>
            <input type="text" id="entidad" name="entidad" placeholder="Nombre de la Entidad">
        </form>
        <form action="../backend/api_racebook/signup/organizador/imagen.php" enctype="multipart/form-data" method="post">
            <!--Formulario para recoger la imagen de usuario; se manda directo a la API-->
            <div>Sube una imagen de perfil</div>
            <input type="file" name="imagen" id="imagen">
            <input type="number" name="idUsuario" id="idUsuario" style="display: none;">
            <input type="submit" value="Cargar Imagen" name="imagen" id="cargarImagen">
        </form>
        <div id="finalizarRegistro">Finalizar Registro</div>
    </main>
    <!--El footer no se muestra en dispositivos moviles-->
    <footer>
        <a href="./politica.html">Política de Privacidad</a>
        <a href="./contacto.html">Atención al Cliente</a>
    </footer>
</body>
<script>
    let iconoMenu = document.getElementById('menu-hamburguesa');
    let menuDesplegable = document.getElementById('enlaces-menu-desplegable');
    let mainContainer = document.getElementById('mainContainer');
    iconoMenu.addEventListener('click', (event) => {
        menuDesplegable.classList.toggle('hidden');
    })
    mainContainer.addEventListener('click', (event) => {
        if(!menuDesplegable.classList.contains('hidden')){
            menuDesplegable.classList.toggle('hidden');
        }
    })
    //Se recoge el idUsuario del JWT y se guarda en el dataset del elemento #idUsuario
    let idUsuario = document.getElementById('idUsuario');
    let jwt = getLocalJWT();
    let decodedJWT = decodeJWT(jwt);
    idUsuario.dataset.idUsuario = decodedJWT.idUsuario;
    //al pulsar en finalizarRegistro se envian los datos a la API
    let finalizarRegistro = document.getElementById('finalizarRegistro');
    finalizarRegistro.addEventListener('click', validarDatos);
    function validarDatos(){
        let tel = document.getElementById('telefono');
        let reg = /^[679]\d{8}$/;
        if(tel.value.match(reg)){
            handleSignUp();
        }else{
            alert('Has introducido un número de teléfono incorrecto');
            tel.value='';
        }
    }
    async function handleSignUp(){
        let alert = document.getElementById('login-alert');
        let data = {
            nombre: document.getElementById('nombre').value,
            nickname: document.getElementById('nickname').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            idUsuario: document.getElementById('idUsuario').dataset.idUsuario,
        }
        let url = '../backend/api_racebook/signup/usuario/';
        fetch(url,{
            method: 'POST',
            body: JSON.stringify(datos),
            headers:{
                'Content-Type': 'application/json;utf-8'
            },
            body: JSON.stringify(data),
            mode: 'cors'
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if(data.status == 200){
                window.location.href = './login.html';
            }else{
                alert.innerText = 'Error al completar registro intentalo de nuevo';
            }
        })
    }
</script>
</html>