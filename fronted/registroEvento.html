<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esqueleto</title>
    <link rel="stylesheet" href="./css/css.css">
    <link rel="stylesheet" href="./css/landing.css">
    <script src="https://kit.fontawesome.com/a5191f3c7b.js" crossorigin="anonymous"></script>
    <script src="./js/jwt.js"></script>
</head>
<body>
    <header id="headerbar">
        <a href="./main.html" class="enlace-header">
            <i class="fa-solid fa-person-running">
                <span class="header-span">RaceBook</span>
            </i>
        </a>
        <!-- Si la pantalla es suficientemente grande se mostrará el #headerbarlinks ; en movil se mostrara un menú desplegable-->
        <div id="headerbarlinks">
            <a class="enlace-header" href="./main.html">Catálogo de Carreras</a>
            <!--Cuando el usuario se ha logeado el contenido de este elemento cambia; será un acceso a la cuenta del usuario-->
            <a class="enlace-header" id="enlace-cuenta" href="./login.html" id="loginbuttonheader">
                <i class="fa-regular fa-user">
                    <span  class="header-span">Login</span>
                </i>
            </a>
        </div>
        <div id="menu-desplegable">
            <div id="burguer-menu">
                <i class="fa-solid fa-bars" id="menu-hamburguesa"></i>
                <ul id="enlaces-menu-desplegable" class="hidden">
                    <li><a class="enlace-menu-hambuerguesa" href="./main.html">Catálogo de Carreras</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./registro.html">Registro</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./login.html">Login</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./politica.html">Términos Legales</a></li>
                    <li><a class="enlace-menu-hambuerguesa" href="./contancto.html">Atención al Cliente</a></li>
                </ul>
            </div>
        </div>
    </header>
    <!--Estos dos divs corresponden a la capa de fondo de pantalla mas la capa de transparencia ocupan todo el alto que no ocupa el header-->
    <div id="background"></div>
    <div id="opaca"></div>
    <nav>
        <div id="searchbar"></div>
        <div id="breadcrumbs"></div>
    </nav>
    <main id="mainContainer">
        <h3>Registro de Evento deportivo</h3>
        <div id="loginAlert">Rellena los datos para registar el evento</div>
        <form action="" id="form-insert-evento" method="post">
            <!-- nombre -->
            <label for="nombre">Nombre del Evento</label>
            <input type="text" name="nombre" id="nombre" required>
            <!-- fecha de inicio -->
            <label for="fechaInicio">Fecha de Inicio</label>
            <input type="date" name="fechaInicio" id="fechaInicio" required>
            <!-- fecha de fin -->
            <label for="fechaFin">Fecha de Fin</label>
            <input type="date" name="fechaFin" id="fechaFin" required>
            <!-- localidad -->
            <label for="localidad">Localidad</label>
            <input type="text" name="localidad" id="localidad" required>
            <!-- provincia -->
            <label for="provincia">Provincia</label>
            <input type="text" name="provincia" id="provincia" required>
            <!-- web del organizador -->
            <label for="web">Web del Organizador</label>
            <input type="text" name="web" id="web" required>
            <!-- reglamento -->
            <label for="reglamento">Reglamento</label>
            <input type="file" name="reglamento" id="reglamento" required>
            <!-- registrar -->
            <span id="registrarEvento">Registrar Evento</span>
        </form>
    </main>
    <!--El footer no se muestra en dispositivos moviles-->
    <footer>
        <a href="./politica.html">Política de Privacidad</a>
        <a href="./contacto.html">Atención al Cliente</a>
    </footer>
</body>
<script>
    let alert = document.getElementById('loginAlert');
    let iconoMenu = document.getElementById('menu-hamburguesa');
    let menuDesplegable = document.getElementById('enlaces-menu-desplegable');
    let mainContainer = document.getElementById('mainContainer');
    iconoMenu.addEventListener('click', (event) => {
        menuDesplegable.classList.toggle('hidden');
    })
    mainContainer.addEventListener('click', (event) => {
        if(!menuDesplegable.classList.contains('hidden')){
            menuDesplegable.classList.toggle('hidden');
        }
    })
    let jwt = getLocalJWT();
    let jwtDecoded = JWT_decode(jwt);
    console.log(jwtDecoded);
    if(!jwtDecoded.userData.isAdmin){
        alert('Solo los organizadores pueden Registrar Eventos');
        //window.location.href='./main.html';
    }
    let registrarEvento = document.getElementById('registrarEvento');
    registrarEvento.addEventListener('click', checkData);

    function checkData(){
        let nombre = document.getElementById('nombre').value;
        let fechaInicio = document.getElementById('fechaInicio').value;
        let fechaFin = document.getElementById('fechaFin').value;
        let localidad = document.getElementById('localidad').value;
        let provincia = document.getElementById('provincia').value;
        let web = document.getElementById('web').value;
        let reglamento = document.getElementById('reglamento').value;
        if(nombre && fechaInicio && fechaFin && localidad && provincia && web && reglamento){
            handleEventSignUp();
        }else{
           alert.innerHTML = 'Rellena todos los campos para registrar el evento';
        }
    }

    function handleEventSignUp(){
        let formData = new FormData();
        formData.append('nombre', document.getElementById('nombre').value);
        formData.append('fechaInicio', document.getElementById('fechaInicio').value);
        formData.append('fechaFin', document.getElementById('fechaFin').value);
        formData.append('localidad', document.getElementById('localidad').value);
        formData.append('provincia', document.getElementById('provincia').value);
        formData.append('web', document.getElementById('web').value);
        formData.append('reglamento', document.getElementById('reglamento').files[0]);
        formData.append('idOrganizador', jwtDecoded.userData.userId);

        let url = 'http://localhost:3000/backend/api_racebook/eventos/new/';
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;utf-8',
            },
            body: formData,
            mode: 'cors'
        })
        .then(response => {
            if(response.status == 201){
                return response.json();
            }else{
                loginAlert.innerHTML = 'Error al registrar el evento. Intentalo de nuevo pasados unos minutos';
            }
        })
        .then(data => {
            let datosEvento = data;
            if(datosEvento){
                localStorage.setItem('datosEvento', datosEvento);//tengo que borrar este token cuando termine de subir las carreras de este evento
                window.location.href = './registroCarrera.html';
            }else{
                loginAlert.innerHTML = 'Error al registrar el evento. Intentalo de nuevo pasados unos minutos';
            }
        })
    };
</script>
</html>