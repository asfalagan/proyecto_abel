<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/a5191f3c7b.js" crossorigin="anonymous"></script>
    <script src="./js/jwt.js"></script>
    <title>Document</title>
    <style>
      .active > .page-link{
        background-color: #f8f9fa !important;
        color: #2b3035 !important;
        border-color: #f8f9fa !important;
        font-weight: bold;
      }
        .card{
          opacity: 0.8 !important;
        }
        .hidden{
            display: none !important;
        }
        #capaOpaca {
            opacity: 0.60;
            z-index: -100;
            width: 100vw;
            height: 100vh;
            position: fixed;
            background-color: black;
        }
        body{
            background-image: url("images/background_movil_def.jpeg");
            background-color: black;
            background-repeat: no-repeat;
            background-size: cover;
            height: 100%;
            width: 100vw;
        }
        .contenidoCentrado{
            display: flex;
            justify-content: center;
            align-items:flex-end;
        }
        * {
          color: #f8f9fa !important;
        }
        .redondeada{
        border-radius: 1em;
        }
        /**ESTILOS PANTALLA MEDIANA -> Tablet**/
        @media (min-width: 768px){
          body{
              background-image: url("images/background_tablet-def.jpeg");
          }
          .card{
            opacity: 0.8 !important;
          }
          .card:hover{
            opacity: 1 !important;
          }
        }
        /**ESTILOS PANTALLA PEQUEÑA**/
        @media (min-width: 1350px){
            body{
                background-image: url("images/background_tablet-def.jpeg");
            }
        }
      /**ESTILOS PANTALLA GRANDE**/
        @media (min-width: 1600px){
          body{
              background-image: url("images/backgroundv0.jpg");
          }
        }
    </style>
</head>
<body  data-bs-theme="dark">
    <div id="capaOpaca"></div>
  
    <nav class="navbar navbar-expand-lg  bg-dark">
        <div class="container-fluid ms-3  me-5">
          <a class="navbar-brand" href="#">
            <i class="fa-solid fa-person-running"></i>
            <span>RaceBook</span>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Catálogo de Carreras</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" id="enlaceCuenta">Login</a>
              </li>
            </ul>
        
            
          </div>
        </div>
    </nav>
    <main class="container-fluid ">
        
        <div class="row justify-content-center mt-4 mb-3">
            
            <form class="col-10 col-sm-8  col-lg-6 col-xxl-4 redondeada pt-4 pb-4 ps-5 pe-5 bg-dark"  style=" opacity: 0.9;">
                <div class="row mt-2">
                    <h1 class="col-12 text-left">Registro de Eventos</h1>
                </div>
                <div class="row mt-3">
                    <div class="mb-3 col-12">
                        <label for="nombre" class="form-label">Nombre del Evento</label>
                        <input type="text" class="form-control bg-transparent border border-light" id="nombre">
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="mb-3 col-12 col-md-5">
                        <label for="fechaInicio" class="form-label">Fecha de Inicio</label>
                        <input type="date" class="form-control bg-transparent border border-light" id="fechaInicio">
                    </div>
                    <div class="mb-3 col-12 col-md-5">
                        <label for="fechaFin" class="form-label">Fecha de Finalización</label>
                        <input type="date" class="form-control bg-transparent border border-light" id="fechaFin">
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="mb-3 col-12 col-md-5">
                        <label for="localidad" class="form-label">Localidad</label>
                        <input type="text" class="form-control bg-transparent border border-light" id="localidad">
                    </div>
                    <div class="mb-3 col-12 col-md-5">
                        <label for="provincia" class="form-label">Provincia</label>
                        <select required name="provincia" class="form-control border border-light" id="provincia">
                          <option value="">. . .</option>
                          <option value="Álava">Álava</option>
                          <option value="Albacete">Albacete</option>
                          <option value="Alicante">Alicante</option>
                          <option value="Almería">Almería</option>
                          <option value="Asturias">Asturias</option>
                          <option value="Ávila">Ávila</option>
                          <option value="Badajoz">Badajoz</option>
                          <option value="Baleares">Baleares</option>
                          <option value="Barcelona">Barcelona</option>
                          <option value="Burgos">Burgos</option>
                          <option value="Cáceres">Cáceres</option>
                          <option value="Cádiz">Cádiz</option>
                          <option value="Cantabria">Cantabria</option>
                          <option value="Castellón">Castellón</option>
                          <option value="Ceuta">Ceuta</option>
                          <option value="Ciudad Real">Ciudad Real</option>
                          <option value="Córdoba">Córdoba</option>
                          <option value="Cuenca">Cuenca</option>
                          <option value="Girona">Girona</option>
                          <option value="Granada">Granada</option>
                          <option value="Guadalajara">Guadalajara</option>
                          <option value="Gipuzkoa">Gipuzkoa</option>
                          <option value="Huelva">Huelva</option>
                          <option value="Huesca">Huesca</option>
                          <option value="Jaén">Jaén</option>
                          <option value="A Coruña">A Coruña</option>
                          <option value="La Rioja">La Rioja</option>
                          <option value="Las Palmas">Las Palmas</option>
                          <option value="León">León</option>
                          <option value="Lleida">Lleida</option>
                          <option value="Lugo">Lugo</option>
                          <option value="Madrid">Madrid</option>
                          <option value="Málaga">Málaga</option>
                          <option value="Melilla">Melilla</option>
                          <option value="Murcia">Murcia</option>
                          <option value="Navarra">Navarra</option>
                          <option value="Ourense">Ourense</option>
                          <option value="Palencia">Palencia</option>
                          <option value="Pontevedra">Pontevedra</option>
                          <option value="Salamanca">Salamanca</option>
                          <option value="Segovia">Segovia</option>
                          <option value="Sevilla">Sevilla</option>
                          <option value="Soria">Soria</option>
                          <option value="Tarragona">Tarragona</option>
                          <option value="Tenerife">Tenerife</option>
                          <option value="Teruel">Teruel</option>
                          <option value="Toledo">Toledo</option>
                          <option value="Valencia">Valencia</option>
                          <option value="Valladolid">Valladolid</option>
                          <option value="Bizkaia">Bizkaia</option>
                          <option value="Zamora">Zamora</option>
                          <option value="Zaragoza">Zaragoza</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-12">
                        <label for="webEvento" class="form-label">Web del Evento</label>
                        <input type="text" class="form-control bg-transparent border border-light" id="webEvento">
                    </div>
                </div>
                <div class="row">
                    <div class="mb-3 col-12">
                        <label for="reglamento" class="form-label">Reglamento del Evento (PDF)</label>
                        <input type="file" class="form-control bg-transparent border border-light" id="reglamento">
                    </div>
                    <!-- <div class="mb-3 col-4">
                      <label for="imagen" class="form-label">Cargar</label>
                      <span id="cargarCartel"  class="col-12 btn btn-light"><strong style="color: #2b3035 !important;">Cargar</strong></span>
                    </div> -->
                </div>
                <div class="row">
                  <div class="mb-3 col-8">
                      <label for="cartel" class="form-label">Agregar cartel del Evento. Tamaño 9:16</label>
                      <input type="file" class="form-control bg-transparent border border-light" id="cartel">
                  </div>
                  <div class="mb-3 col-4">
                    <label for="imagen" class="form-label">Cargar</label>
                    <span id="cargarCartel"  class="col-12 btn btn-light"><strong style="color: #2b3035 !important;">Cargar</strong></span>
                </div>
              </div>
                <!-- <div class="row">
                    <div class="mb-3 col-8">
                        <label for="cartel" class="form-label">Galería de Imágenes (16:9)</label>
                        <input type="file" class="form-control bg-transparent border border-light" id="imagen">
                    </div>
                    <div class="mb-3 col-4">
                        <label for="imagen" class="form-label">Cargar</label>
                        <span id="cargarImagen"  class="col-12 btn btn-light"><strong style="color: #2b3035 !important;">Cargar</strong></span>
                    </div>
                </div>                   -->
                <div class="row justify-content-center">
                    <div id="formAlert" class="m-4">Pulsa Continuar para registrar carreras</div>
                    <input type="submit" value="Continuar" class="col-4 btn btn-warning" id="registrarEvento" style="color: #2b3035 !important;">
                </div>
            </form>
        </div>
    </main>

    

</body>
<script>
  //https://www.npmjs.com/package/exif-js Libreria para controlar el tamaño de foto
  const url = 'http://localhost:3000/backend/api_racebook/eventos/new/';
  const urlArchivos = 'http://localhost:3000/backend/api_racebook/eventos/new_archivos/';
  const form = document.getElementsByTagName('form')[0];
  const imagen = document.getElementById('imagen');
  const formAlert = document.getElementById('formAlert');
  const nombre = document.getElementById('nombre');
  const fechaInicio = document.getElementById('fechaInicio');
  const fechaFin = document.getElementById('fechaFin');
  const localidad = document.getElementById('localidad');
  const provincia = document.getElementById('provincia');
  const webEvento = document.getElementById('webEvento');
  const cartel = document.getElementById('cartel');
  const registrarEvento = document.getElementById('registrarEvento');
  const reglamento = document.getElementById('reglamento');
  const body = document.querySelector('body');
  let contadorImagenes = 0;

  let formData = new FormData();
  let eventoId;
  registrarEvento.addEventListener('click', handleSignUp);
  //al cargar el formulario en el DOM elimino su comportamiento por defecto
  form.addEventListener('change', (event) => {
    console.log('jeeeeeeeeeeeeeeeeeeeee');
    event.preventDefault();
  })
  body.addEventListener('keydown', (event) => {
    if(event.key == 'Enter'){
      handleSignUp();
    }
  })
  // reglamento.addEventListener('change', (event) => {
  //   console.log('has cargado un reglamento');
  //   if(reglamento.files[0] == undefined){
  //     formAlert.innerHTML = 'Parece que no has cargado el reglamento';
  //   }else{
  //     //compruebo que el archivo sea un pdf
  //     let extension = reglamento.files[0].name.split('.').pop();
  //     if(extension != 'pdf'){
  //       formAlert.innerHTML = 'El archivo debe ser un PDF';
  //       reglamento.value = '';
  //     }else{
  //       formData.append('reglamento', reglamento.files[0], reglamento.files[0].name);
  //       console.log('reglamento añadido');
  //     }
  //   }
  // })
  
  // imagen.addEventListener('change', (event) => {
  //   if(imagen.files[0] == undefined){
  //     formAlert.innerHTML = 'Parece que no has cargado la imagen';
  //   }else{
  //     //compruebo que el archivo sea una imagen
  //     let extension = imagen.files[0].name.split('.').pop();
  //     if(extension != 'jpg' && extension != 'jpeg' && extension != 'png'){
  //       formAlert.innerHTML = 'El archivo debe ser una imagen jpg, jpeg o png';
  //       imagen.value = '';
  //     }else{
  //       formAlert.innerHTML = 'Puedes subir más imágenes si lo deseas';
  //       formData.append(`imagen${contadorImagenes}`, imagen.files[contadorImagenes], imagen.files[contadorImagenes].name);
  //       console.log('imagen añadida');
  //       contadorImagenes++;
  //     }
  //   }
  // })
  
  // cartel.addEventListener('change', (event) => {
  //   console.log('has cambiado el cartel');
  //   if(cartel.files[0] == undefined){
  //     formAlert.innerHTML = 'Parece que no has cargado el cartel';
  //   }else{
  //     //compruebo que el archivo sea una imagen
  //     let extension = cartel.files[0].name.split('.').pop();
  //     if(extension != 'jpg' && extension != 'jpeg' && extension != 'png'){
  //       formAlert.innerHTML = 'El archivo debe ser una imagen jpg, jpeg o png';
  //       cartel.value = '';
  //     }else{
  //       formData.append('cartel', cartel.files[0], cartel.files[0].name);
  //       console.log(formData);
  //       console.log('cartel añadido');
  //     }
  //   }
  // })

  function handleSignUp(event){
    event.preventDefault();
    if(nombre.value == '' || fechaInicio.value == '' || fechaFin.value == '' || localidad.value == '' || provincia.value == '' || webEvento.value == '' || cartel.value == '' || reglamento.value == ''){
      formAlert.innerHTML = 'Rellena todos los campos';
    }else{
        //recojo el idUsuario del token userData
        let userIdentificationData = localStorage.getItem('userData');
        userIdentificationData = JWT_decode(userIdentificationData);
        let userId = userIdentificationData.userData.userId;
        let data = {
            nombre: nombre.value,
            fechaInicio: fechaInicio.value,
            fechaFin: fechaFin.value,
            localidad: localidad.value,
            provincia: provincia.value,
            webEvento: webEvento.value,
            userId: userId,
        };

      
      fetch(url, {
        headers: {
          'Content-Type': 'application/json;utf-8'
        },
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(response => {
        if(response.status == 201){
          formAlert.textContent = 'Estamos registrando el evento, por favor, espera...';
          console.log(response);
          return response.json();
        }else{
          formAlert.textContent = 'Ha habido un error al registrar el evento';
        }   
      })
      .then(data => {
          console.log(data);
          eventoId = data.eventoId;
          localStorage.setItem('evento', eventoId);
          
          
      })
      .then(() => {
        console.log('Estoy en ello');
        formData.append('eventoId', 'eventoId');
        formData.append('reglamento', reglamento.files[0], reglamento.files[0].name);
        formData.append('cartel', cartel.files[0], cartel.files[0].name);
        console.log(formData);
        fetch(urlArchivos, {
                method: 'POST',
                body: formData,
              })
              .then(response => {
                if(response.status == 201){
                  formAlert.textContent = 'Evento registrado con éxito';
                //   window.location.href = 'otraversionRegistroCarrera.html';
                console.log(response);
                }else{
                  formAlert.textContent = 'Ha habido un error al registrar el evento con los archivos';
                
                }
        })
      })
    }
  }
</script>
</html>